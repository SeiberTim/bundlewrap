<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Custom items - BundleWrap</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../bundlewrap.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BundleWrap</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link"><i class="fa fa-home"></i></a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../quickstart/" class="dropdown-item">Quickstart</a>
</li>
                                    
<li>
    <a href="../installation/" class="dropdown-item">Installation</a>
</li>
                                    
<li>
    <a href="../cli/" class="dropdown-item">CLI</a>
</li>
                                    
<li>
    <a href="../env/" class="dropdown-item">Environment Variables</a>
</li>
                                    
<li>
    <a href="../item_file_templates/" class="dropdown-item">File templates</a>
</li>
                                    
<li>
    <a href="../secrets/" class="dropdown-item">Handling secrets</a>
</li>
                                    
<li>
    <a href="../locks/" class="dropdown-item">Locking</a>
</li>
                                    
<li>
    <a href="../kubernetes/" class="dropdown-item">Kubernetes</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Custom items</a>
</li>
                                    
<li>
    <a href="../api/" class="dropdown-item">Python API</a>
</li>
                                    
<li>
    <a href="../os_compatibility/" class="dropdown-item">OS compatibility</a>
</li>
                                    
<li>
    <a href="../toml/" class="dropdown-item">TOML nodes and groups</a>
</li>
                                    
<li>
    <a href="../selectors/" class="dropdown-item">Selectors</a>
</li>
                                    
<li>
    <a href="../migrate_12/" class="dropdown-item">Migrating to 2.0</a>
</li>
                                    
<li>
    <a href="../migrate_23/" class="dropdown-item">Migrating to 3.0</a>
</li>
                                    
<li>
    <a href="../migrate_34/" class="dropdown-item">Migrating to 4.0</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Repository <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../repo/layout/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../repo/nodes.py/" class="dropdown-item">nodes.py</a>
</li>
                                    
<li>
    <a href="../../repo/groups.py/" class="dropdown-item">groups.py</a>
</li>
                                    
<li>
    <a href="../../repo/requirements.txt/" class="dropdown-item">requirements.txt</a>
</li>
                                    
<li>
    <a href="../../repo/bundle.py/" class="dropdown-item">bundles/.../bundle.py</a>
</li>
                                    
<li>
    <a href="../../repo/items.py/" class="dropdown-item">bundles/.../items.py</a>
</li>
                                    
<li>
    <a href="../../repo/metadata.py/" class="dropdown-item">bundles/.../metadata.py</a>
</li>
                                    
<li>
    <a href="../../repo/hooks/" class="dropdown-item">hooks/</a>
</li>
                                    
<li>
    <a href="../../repo/libs/" class="dropdown-item">libs/</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Items <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../items/action/" class="dropdown-item">action</a>
</li>
                                    
<li>
    <a href="../../items/directory/" class="dropdown-item">directory</a>
</li>
                                    
<li>
    <a href="../../items/file/" class="dropdown-item">file</a>
</li>
                                    
<li>
    <a href="../../items/git_deploy/" class="dropdown-item">git_deploy</a>
</li>
                                    
<li>
    <a href="../../items/group/" class="dropdown-item">group</a>
</li>
                                    
<li>
    <a href="../../items/k8s/" class="dropdown-item">k8s_*</a>
</li>
                                    
<li>
    <a href="../../items/pkg_apk/" class="dropdown-item">pkg_apk</a>
</li>
                                    
<li>
    <a href="../../items/pkg_apt/" class="dropdown-item">pkg_apt</a>
</li>
                                    
<li>
    <a href="../../items/pkg_dnf/" class="dropdown-item">pkg_dnf</a>
</li>
                                    
<li>
    <a href="../../items/pkg_freebsd/" class="dropdown-item">pkg_freebsd</a>
</li>
                                    
<li>
    <a href="../../items/pkg_openbsd/" class="dropdown-item">pkg_openbsd</a>
</li>
                                    
<li>
    <a href="../../items/pkg_opkg/" class="dropdown-item">pkg_opkg</a>
</li>
                                    
<li>
    <a href="../../items/pkg_pacman/" class="dropdown-item">pkg_pacman</a>
</li>
                                    
<li>
    <a href="../../items/pkg_pip/" class="dropdown-item">pkg_pip</a>
</li>
                                    
<li>
    <a href="../../items/pkg_snap/" class="dropdown-item">pkg_snap</a>
</li>
                                    
<li>
    <a href="../../items/pkg_yum/" class="dropdown-item">pkg_yum</a>
</li>
                                    
<li>
    <a href="../../items/pkg_zypper/" class="dropdown-item">pkg_zypper</a>
</li>
                                    
<li>
    <a href="../../items/postgres_db/" class="dropdown-item">postgres_db</a>
</li>
                                    
<li>
    <a href="../../items/postgres_role/" class="dropdown-item">postgres_role</a>
</li>
                                    
<li>
    <a href="../../items/routeros/" class="dropdown-item">routeros</a>
</li>
                                    
<li>
    <a href="../../items/svc_openbsd/" class="dropdown-item">svc_openbsd</a>
</li>
                                    
<li>
    <a href="../../items/svc_openrc/" class="dropdown-item">svc_openrc</a>
</li>
                                    
<li>
    <a href="../../items/svc_systemd/" class="dropdown-item">svc_systemd</a>
</li>
                                    
<li>
    <a href="../../items/svc_systemv/" class="dropdown-item">svc_systemv</a>
</li>
                                    
<li>
    <a href="../../items/svc_upstart/" class="dropdown-item">svc_upstart</a>
</li>
                                    
<li>
    <a href="../../items/symlink/" class="dropdown-item">symlink</a>
</li>
                                    
<li>
    <a href="../../items/user/" class="dropdown-item">user</a>
</li>
                                    
<li>
    <a href="../../items/zfs_dataset/" class="dropdown-item">zfs_dataset</a>
</li>
                                    
<li>
    <a href="../../items/zfs_pool/" class="dropdown-item">zfs_pool</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../misc/about/" class="dropdown-item">About</a>
</li>
                                    
<li>
    <a href="../../misc/deciding/" class="dropdown-item">Why BundleWrap</a>
</li>
                                    
<li>
    <a href="../../misc/glossary/" class="dropdown-item">Glossary</a>
</li>
                                    
<li>
    <a href="../../misc/faq/" class="dropdown-item">FAQ</a>
</li>
                                    
<li>
    <a href="../../misc/contributing/" class="dropdown-item">Contributing</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../kubernetes/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../api/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/bundlewrap/bundlewrap/edit/master/docs/guide/dev_item.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#custom-item-types" class="nav-link">Custom item types</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#step-0-understand-statedicts" class="nav-link">Step 0: Understand statedicts</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#step-1-create-an-item-module" class="nav-link">Step 1: Create an item module</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#step-2-define-attributes" class="nav-link">Step 2: Define attributes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#step-3-implement-methods" class="nav-link">Step 3: Implement methods</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="custom-item-types">Custom item types</h1>
<h2 id="step-0-understand-statedicts">Step 0: Understand statedicts</h2>
<p>To represent supposed vs. actual state, BundleWrap uses statedicts. These are
normal Python dictionaries with some restrictions:</p>
<ul>
<li>keys must be Unicode text</li>
<li>every value must be of one of these simple data types:<ul>
<li>bool</li>
<li>float</li>
<li>int</li>
<li>Unicode text</li>
<li>None</li>
</ul>
</li>
<li>...or a list/tuple containing only instances of one of the types above</li>
</ul>
<p>Additional information can be stored in statedicts by using keys that start with an underscore. You may only use this for caching purposes (e.g. storing rendered file template content while the "real" sdict information only contains a hash of this content). BundleWrap will ignore these keys and hide them from the user. The type restrictions noted above do not apply.</p>
<h2 id="step-1-create-an-item-module">Step 1: Create an item module</h2>
<p>Create a new file called <code>/your/bundlewrap/repo/items/foo.py</code>. You can use this as a template:</p>
<pre><code>from bundlewrap.items import Item


class Foo(Item):
    """
    A foo.
    """
    BUNDLE_ATTRIBUTE_NAME = "foo"
    ITEM_ATTRIBUTES = {
        'attribute': "default value",
    }
    ITEM_TYPE_NAME = "foo"
    REQUIRED_ATTRIBUTES = ['attribute']

    @classmethod
    def block_concurrent(cls, node_os, node_os_version):
        """
        Return a list of item types that cannot be applied in parallel
        with this item type.
        """
        return []

    def __repr__(self):
        return "&lt;Foo attribute:{}&gt;".format(self.attributes['attribute'])

    def cdict(self):
        """
        Return a statedict that describes the target state of this item
        as configured in the repo. An empty dict means that the item
        should not exist.

        Implementing this method is optional. The default implementation
        uses the attributes as defined in the bundle.
        """
        raise NotImplementedError

    def sdict(self):
        """
        Return a statedict that describes the actual state of this item
        on the node. An empty dict means that the item does not exist
        on the node.

        For the item to validate as correct, the values for all keys in
        self.cdict() have to match this statedict.
        """
        raise NotImplementedError

    def display_on_create(self, cdict):
        """
        Given a cdict as implemented above, modify it to better suit
        interactive presentation when an item is created.

        Implementing this method is optional.
        """
        return cdict

    def display_dicts(self, cdict, sdict, keys):
        """
        Given cdict and sdict as implemented above, modify them to
        better suit interactive presentation. The keys parameter is a
        list of keys whose values differ between cdict and sdict.

        Implementing this method is optional.
        """
        return (cdict, sdict, keys)

    def display_on_delete(self, sdict):
        """
        Given an sdict as implemented above, modify it to better suit
        interactive presentation when an item is deleted.

        Implementing this method is optional.
        """
        return sdict

    def fix(self, status):
        """
        Do whatever is necessary to correct this item. The given ItemStatus
        object has the following useful information:

            status.keys_to_fix  list of cdict keys that need fixing
            status.cdict        cached copy of self.cdict()
            status.sdict        cached copy of self.sdict()
        """
        raise NotImplementedError
</code></pre>
<p><br></p>
<h2 id="step-2-define-attributes">Step 2: Define attributes</h2>
<p><code>BUNDLE_ATTRIBUTE_NAME</code> is the name of the variable defined in a bundle module that holds the items of this type. If your bundle looks like this:</p>
<pre><code>foo = { [...] }
</code></pre>
<p>...then you should put <code>BUNDLE_ATTRIBUTE_NAME = "foo"</code> here.</p>
<p><code>ITEM_ATTRIBUTES</code> is a dictionary of the attributes users will be able to configure for your item. For files, that would be stuff like owner, group, and permissions. Every attribute (even if it's mandatory) needs a default value, <code>None</code> is totally acceptable:</p>
<pre><code>ITEM_ATTRIBUTES = {'attr1': "default1"}
</code></pre>
<p><code>ITEM_TYPE_NAME</code> sets the first part of an items ID. For the file items, this is "file". Therefore, file ID look this this: <code>file:/path</code>. The second part is the name a user assigns to your item in a bundle. Example:</p>
<pre><code>ITEM_TYPE_NAME = "foo"
</code></pre>
<p><code>REQUIRED_ATTRIBUTES</code> is a list of attribute names that must be set on each item of this type. If BundleWrap encounters an item without all these attributes during bundle inspection, an exception will be raised. Example:</p>
<pre><code>REQUIRED_ATTRIBUTES = ['attr1', 'attr2']
</code></pre>
<p><br></p>
<h2 id="step-3-implement-methods">Step 3: Implement methods</h2>
<p>You should probably start with <code>sdict()</code>. Use <code>self.run("command")</code> to run shell commands on the current node and check the <code>stdout</code> property of the returned object.</p>
<p>The only other method you have to implement is <code>fix</code>. It doesn't have to return anything and just uses <code>self.run()</code> to fix the item. To do this efficiently, it may use the provided parameters indicating which keys differ between the should-be sdict and the actual one. Both sdicts are also provided in case you need to know their values.</p>
<p><code>block_concurrent()</code> must return a list of item types (e.g. <code>['pkg_apt']</code>) that cannot be applied in parallel with this type of item. May include this very item type itself. For most items this is not an issue (e.g. creating multiple files at the same time), but some types of items have to be applied sequentially (e.g. package managers usually employ locks to ensure only one package is installed at a time).</p>
<p>If you're having trouble, try looking at the <a href="https://github.com/bundlewrap/bundlewrap/tree/master/bundlewrap/items">source code for the items that come with BundleWrap</a>. The <code>pkg_*</code> items are pretty simple and easy to understand while <code>files</code> is the most complex to date. Or just drop by on <a href="irc://irc.libera.chat/bundlewrap">IRC</a> or <a href="https://github.com/bundlewrap/bundlewrap/discussions">GitHub</a>, we're glad to help.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>BundleWrap is published under the <a href='https://github.com/bundlewrap/bundlewrap/blob/master/LICENSE'>GPL license</a>.</p><p> Donations welcome in Bitcoin <code>13AJYksqncZromPF8HvDUXsmHChAm3Y7W7</code> or Ethereum <code>0x5Eb3037e197d3C0d2E014bcfC2e027EB0AD42812</code>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
