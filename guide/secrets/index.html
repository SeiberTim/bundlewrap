<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Handling secrets - BundleWrap</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../../bundlewrap.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BundleWrap</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link"><i class="fa fa-home"></i></a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../quickstart/" class="dropdown-item">Quickstart</a>
</li>
                                    
<li>
    <a href="../installation/" class="dropdown-item">Installation</a>
</li>
                                    
<li>
    <a href="../cli/" class="dropdown-item">CLI</a>
</li>
                                    
<li>
    <a href="../env/" class="dropdown-item">Environment Variables</a>
</li>
                                    
<li>
    <a href="../item_file_templates/" class="dropdown-item">File templates</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Handling secrets</a>
</li>
                                    
<li>
    <a href="../locks/" class="dropdown-item">Locking</a>
</li>
                                    
<li>
    <a href="../kubernetes/" class="dropdown-item">Kubernetes</a>
</li>
                                    
<li>
    <a href="../dev_item/" class="dropdown-item">Custom items</a>
</li>
                                    
<li>
    <a href="../api/" class="dropdown-item">Python API</a>
</li>
                                    
<li>
    <a href="../os_compatibility/" class="dropdown-item">OS compatibility</a>
</li>
                                    
<li>
    <a href="../toml/" class="dropdown-item">TOML nodes and groups</a>
</li>
                                    
<li>
    <a href="../selectors/" class="dropdown-item">Selectors</a>
</li>
                                    
<li>
    <a href="../migrate_12/" class="dropdown-item">Migrating to 2.0</a>
</li>
                                    
<li>
    <a href="../migrate_23/" class="dropdown-item">Migrating to 3.0</a>
</li>
                                    
<li>
    <a href="../migrate_34/" class="dropdown-item">Migrating to 4.0</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Repository <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../repo/layout/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../repo/nodes.py/" class="dropdown-item">nodes.py</a>
</li>
                                    
<li>
    <a href="../../repo/groups.py/" class="dropdown-item">groups.py</a>
</li>
                                    
<li>
    <a href="../../repo/requirements.txt/" class="dropdown-item">requirements.txt</a>
</li>
                                    
<li>
    <a href="../../repo/bundle.py/" class="dropdown-item">bundles/.../bundle.py</a>
</li>
                                    
<li>
    <a href="../../repo/items.py/" class="dropdown-item">bundles/.../items.py</a>
</li>
                                    
<li>
    <a href="../../repo/metadata.py/" class="dropdown-item">bundles/.../metadata.py</a>
</li>
                                    
<li>
    <a href="../../repo/hooks/" class="dropdown-item">hooks/</a>
</li>
                                    
<li>
    <a href="../../repo/libs/" class="dropdown-item">libs/</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Items <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../items/action/" class="dropdown-item">action</a>
</li>
                                    
<li>
    <a href="../../items/dconf/" class="dropdown-item">dconf</a>
</li>
                                    
<li>
    <a href="../../items/directory/" class="dropdown-item">directory</a>
</li>
                                    
<li>
    <a href="../../items/file/" class="dropdown-item">file</a>
</li>
                                    
<li>
    <a href="../../items/git_deploy/" class="dropdown-item">git_deploy</a>
</li>
                                    
<li>
    <a href="../../items/group/" class="dropdown-item">group</a>
</li>
                                    
<li>
    <a href="../../items/k8s/" class="dropdown-item">k8s_*</a>
</li>
                                    
<li>
    <a href="../../items/pkg_apk/" class="dropdown-item">pkg_apk</a>
</li>
                                    
<li>
    <a href="../../items/pkg_apt/" class="dropdown-item">pkg_apt</a>
</li>
                                    
<li>
    <a href="../../items/pkg_dnf/" class="dropdown-item">pkg_dnf</a>
</li>
                                    
<li>
    <a href="../../items/pkg_freebsd/" class="dropdown-item">pkg_freebsd</a>
</li>
                                    
<li>
    <a href="../../items/pkg_openbsd/" class="dropdown-item">pkg_openbsd</a>
</li>
                                    
<li>
    <a href="../../items/pkg_opkg/" class="dropdown-item">pkg_opkg</a>
</li>
                                    
<li>
    <a href="../../items/pkg_pacman/" class="dropdown-item">pkg_pacman</a>
</li>
                                    
<li>
    <a href="../../items/pkg_pamac/" class="dropdown-item">pkg_pamac</a>
</li>
                                    
<li>
    <a href="../../items/pkg_pip/" class="dropdown-item">pkg_pip</a>
</li>
                                    
<li>
    <a href="../../items/pkg_snap/" class="dropdown-item">pkg_snap</a>
</li>
                                    
<li>
    <a href="../../items/pkg_yum/" class="dropdown-item">pkg_yum</a>
</li>
                                    
<li>
    <a href="../../items/pkg_zypper/" class="dropdown-item">pkg_zypper</a>
</li>
                                    
<li>
    <a href="../../items/postgres_db/" class="dropdown-item">postgres_db</a>
</li>
                                    
<li>
    <a href="../../items/postgres_role/" class="dropdown-item">postgres_role</a>
</li>
                                    
<li>
    <a href="../../items/routeros/" class="dropdown-item">routeros</a>
</li>
                                    
<li>
    <a href="../../items/svc_freebsd/" class="dropdown-item">svc_freebsd</a>
</li>
                                    
<li>
    <a href="../../items/svc_openbsd/" class="dropdown-item">svc_openbsd</a>
</li>
                                    
<li>
    <a href="../../items/svc_openrc/" class="dropdown-item">svc_openrc</a>
</li>
                                    
<li>
    <a href="../../items/svc_systemd/" class="dropdown-item">svc_systemd</a>
</li>
                                    
<li>
    <a href="../../items/svc_systemv/" class="dropdown-item">svc_systemv</a>
</li>
                                    
<li>
    <a href="../../items/svc_upstart/" class="dropdown-item">svc_upstart</a>
</li>
                                    
<li>
    <a href="../../items/symlink/" class="dropdown-item">symlink</a>
</li>
                                    
<li>
    <a href="../../items/user/" class="dropdown-item">user</a>
</li>
                                    
<li>
    <a href="../../items/zfs_dataset/" class="dropdown-item">zfs_dataset</a>
</li>
                                    
<li>
    <a href="../../items/zfs_pool/" class="dropdown-item">zfs_pool</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../misc/about/" class="dropdown-item">About</a>
</li>
                                    
<li>
    <a href="../../misc/deciding/" class="dropdown-item">Why BundleWrap</a>
</li>
                                    
<li>
    <a href="../../misc/glossary/" class="dropdown-item">Glossary</a>
</li>
                                    
<li>
    <a href="../../misc/faq/" class="dropdown-item">FAQ</a>
</li>
                                    
<li>
    <a href="../../misc/contributing/" class="dropdown-item">Contributing</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../item_file_templates/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../locks/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/bundlewrap/bundlewrap/edit/master/docs/guide/secrets.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#handling-secrets" class="nav-link">Handling secrets</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#secretscfg" class="nav-link">.secrets.cfg</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#derived-passwords" class="nav-link">Derived passwords</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#static-passwords" class="nav-link">Static passwords</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#files" class="nav-link">Files</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#external-commands" class="nav-link">External commands</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#key-management" class="nav-link">Key management</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="handling-secrets">Handling secrets</h1>
<p>We strongly recommend <strong>not</strong> putting any sensitive information such as passwords or private keys into your repository. This page describes the helpers available in BundleWrap to manage those secrets without checking them into version control.</p>
<div class="alert alert-info">Most of the functions described here return lazy <a href="../api/#bundlewraputilsfault">Fault objects</a>.</div>

<p><br></p>
<h2 id="secretscfg">.secrets.cfg</h2>
<p>When you initially ran <code>bw repo create</code>, a file called <code>.secrets.cfg</code> was put into the root level of your repo. It's an INI-style file that by default contains two random keys BundleWrap uses to protect your secrets. One for randomly generated passwords, one for symmetric encryption.</p>
<div class="alert alert-danger">You should never commit <code>.secrets.cfg</code>. Immediately add it to your <code>.gitignore</code> or equivalent.</div>

<p><br></p>
<h2 id="derived-passwords">Derived passwords</h2>
<p>In some cases, you can control (i.e. manage with BundleWrap) both ends of the authentication process. A common example is a config file for a web application that holds credentials for a database also managed by BundleWrap. In this case, you don't really care what the password is, you just want it to be the same on both sides.</p>
<p>To accomplish that, just write this in your template (Mako syntax shown here):</p>
<pre><code class="nohighlight">database_user = "foo"
database_password = "${repo.vault.password_for("my database")}"
</code></pre>

<p>In your bundle, you can then configure your database user like this:</p>
<pre><code>postgres_roles = {
    "foo": {
        'password': repo.vault.password_for("my database"),
    },
}
</code></pre>
<p>It doesn't really matter what string you call <code>password_for()</code> with, it just has to be the same on both ends. BundleWrap will then use that string, combine it with the default key called <code>generate</code> in your <code>.secrets.cfg</code> and derive a random password from that.</p>
<p>This makes it easy to change all your passwords at once (e.g. when an employee leaves or when required for compliance reasons) by rotating keys.</p>
<div class="alert alert-warning">However, it also means you have to guard your <code>.secrets.cfg</code> very closely. If it is compromised, so are <strong>all</strong> your passwords. Use your own judgement.</div>

<h3 id="human-passwords">"Human" passwords</h3>
<p>As an alternative to <code>password_for()</code>, which generates random strings, you can use <code>human_password_for()</code>.It generates strings like <code>Wiac-Kaobl-Teuh-Kumd-40</code>. They are easier to handle for human beings. You might want to use them if you have to type those passwords on a regular basis.</p>
<h3 id="random-bytes">Random bytes</h3>
<p><code>password_for()</code> and <code>human_password_for()</code> are meant for passwords. If you need plain random bytes, you can use <code>random_bytes_as_base64_for()</code>. As the name implies, it will return the data base64 encoded. Some examples:</p>
<pre><code class="nohighlight">$ bw debug -c 'print(repo.vault.random_bytes_as_base64_for("foo"))'
qczM0GUKW7YlXEuW8HGPYkjCGaX4Vu9Fja5SIZWga7w=
$ bw debug -c 'print(repo.vault.random_bytes_as_base64_for("foo", length=1))'
qQ==
</code></pre>

<p><br></p>
<h2 id="static-passwords">Static passwords</h2>
<p>When you need to store a specific password, you can encrypt it symmetrically. The <code>bw pw</code> utility provides command line access to the functions attached to <code>repo.vault</code>, so we'll use it here to generate the encrypted string:</p>
<pre><code class="nohighlight">$ bw pw --encrypt 'my password'
gAAAA[...]mrVMA==
</code></pre>

<p>You can then use this encrypted password in a template like this:</p>
<pre><code class="nohighlight">database_user = "foo"
database_password = "${repo.vault.decrypt("gAAAA[...]mrVMA==")}"
</code></pre>

<p><br></p>
<h2 id="files">Files</h2>
<p>You can also encrypt entire files:</p>
<pre><code class="nohighlight">$ bw pw --encrypt --file encrypted.file /my/secret.file</code></pre>

<div class="alert alert-info">Encrypted files are always read and written relative to the <code>data/</code> subdirectory of your repo.</div>

<p>If the source file was encoded using UTF-8, you can then simply pass the decrypted content into a file item:</p>
<pre><code>files = {
    "/secret": {
        'content': repo.vault.decrypt_file("encrypted.file"),
    },
}
</code></pre>
<p>If the source file is binary however (or any encoding other than UTF-8), you must use base64:</p>
<pre><code>files = {
    "/secret": {
        'content': repo.vault.decrypt_file_as_base64("encrypted.file"),
        'content_type': 'base64',
    },
}
</code></pre>
<p><br></p>
<h2 id="external-commands">External commands</h2>
<p>To retrieve secrets using a local shell command, use <code>vault.cmd</code>:</p>
<pre><code class="nohighlight">$ bw debug -c "print(repo.vault.cmd('uname'))"
Linux</code></pre>

<p>By default, the stdout of the given command will be decoded to text using UTF-8 and have leading and trailing whitespace stripped. To prevent this, use the <code>as_text</code> and <code>strip</code> parameters:</p>
<pre><code class="nohighlight">$ bw debug -c "print(repo.vault.cmd('uname', as_text=False, strip=False))"
b'Linux\n'</code></pre>

<p>The point of using <code>repo.vault.cmd()</code> is that (like the other functions introduced on this page) it will return a lazy <code>Fault</code> object that will call the command only if and when the value is actually needed (e.g. when rendering a file template).</p>
<p><br></p>
<h2 id="key-management">Key management</h2>
<h3 id="multiple-keys">Multiple keys</h3>
<p>You can always add more keys to your <code>.secrets.cfg</code>, but you should keep the defaults around. Adding more keys makes it possible to give different keys to different teams. <strong>By default, BundleWrap will skip items it can't find the required keys for</strong>.</p>
<p>When using <code>.password_for()</code>, <code>.encrypt()</code> etc., you can provide a <code>key</code> argument to select the key:</p>
<pre><code>repo.vault.password_for("some database", key="devops")
</code></pre>
<p>On the command line, <code>bw pw</code> also accepts <code>--key</code> for this purpose.</p>
<p>The encrypted data will be prefixed by <code>yourkeyname$...</code> to indicate that the key <code>yourkeyname</code> was used for encryption. Thus, during decryption, you can omit the <code>key=</code> parameter.</p>
<p><br></p>
<h3 id="rotating-keys">Rotating keys</h3>
<p>You can generate a new key by running <code>bw debug -c "print(repo.vault.random_key())"</code>. Place the result in your <code>.secrets.cfg</code>. Then you need to distribute the new key to your team and run <code>bw apply</code> for all your nodes.</p>
<div class="alert alert-info">Note that `encrypt()` and `decrypt()` (plus their `file_` counterparts) use symmetric encryption and require manually updating the encrypted text after the key has changed.</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>BundleWrap is published under the <a href='https://github.com/bundlewrap/bundlewrap/blob/master/LICENSE'>GPL license</a>.</p><p> Donations welcome in Bitcoin <code>13AJYksqncZromPF8HvDUXsmHChAm3Y7W7</code> or Ethereum <code>0x5Eb3037e197d3C0d2E014bcfC2e027EB0AD42812</code>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
